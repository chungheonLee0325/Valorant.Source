# GameplayCue 리팩토링 제안

이 문서는 [프로젝트 회고](./3.1_Project_Retrospective.md)에서 논의된 'Multicast RPC' 기반의 이펙트/사운드 동기화 방식을, 향후 GAS의 `GameplayCue` 시스템으로 전환할 것을 제안하며 구체적인 리팩토링 방안을 다룹니다.

## 1. 현재 구현 (As-Is): Multicast RPC 기반

현재 코드는 어빌리티가 실행될 때, `PlayCommonEffects`와 같은 유틸리티 함수나 직접적인 `MulticastRPC`를 호출하여 모든 클라이언트에 이펙트와 사운드를 동기화하고 있습니다.

```cpp
// In KAYO_Q_FLASHDRIVE.cpp
// View on GitHub: https://github.com/chungheonLee0325/VALORANT/blob/main/UnrealEngine/Valorant/Source/Valorant/AbilitySystem/Abilities/KAYO/KAYO_Q_FLASHDRIVE.cpp#L201

bool UKAYO_Q_FLASHDRIVE::ThrowFlashbang(bool bAltFire)
{
  // ... 투사체 스폰 로직 ...
  if (Flashbang)
  {
    // 발사 효과 재생
    PlayCommonEffects(ProjectileLaunchEffect, ProjectileLaunchSound, SpawnLocation);
    return true;
  }
  return false;
}
```
*   **문제점**: 어빌리티 C++ 코드가 특정 이펙트/사운드 에셋에 직접 의존하게 되며, 네트워크 처리를 개발자가 수동으로 관리해야 하는 부담이 있습니다. 이는 유지보수성을 저해하고 디자이너와의 협업을 어렵게 만듭니다.

## 2. 리팩토링 제안 (To-Be): GameplayCue 기반

리팩토링 후의 코드는 어빌리티 실행 시, 특정 이펙트를 직접 재생하는 대신 `Cue.Ability.KAYO.Flash.Execute`와 같은 의미있는 `GameplayTag`를 전송하는 방식으로 변경될 것입니다.

```cpp
// In KAYO_Q_FLASHDRIVE.cpp (Proposed Change)
void UKAYO_Q_FLASHDRIVE::ThrowFlashbang(bool bAltFire)
{
  // ... 투사체 스폰 로직 ...
  if (Flashbang)
  {
    // GameplayCue 태그를 전송하여 이펙트/사운드 트리거를 요청
    FGameplayCueParameters CueParams;
    CueParams.Location = SpawnLocation;
    UAbilitySystemBlueprintLibrary::SendGameplayCue(
      GetAvatarActorFromActorInfo(),
      FGameplayTag::RequestGameplayTag(TEXT("Cue.Ability.KAYO.Flash.Execute")),
      CueParams);
    return true;
  }
  return false;
}
```
*   **개선점**: 어빌리티는 "무엇을" 실행할지(이펙트, 사운드) 전혀 알 필요 없이, "언제" 실행되어야 하는지(Execute 단계)에 대한 신호만 보내면 됩니다. 실제 이펙트와 사운드는 이 태그에 연결된 `GameplayCue Notify` 블루프린트 에셋에서 디자이너가 자유롭게 설정할 수 있습니다.

## 3. 예상 코드 변경 (Proposed Diff)

아래는 실제 `KAYO_Q_FLASHDRIVE` 어빌리티에 `GameplayCue`를 적용할 경우의 예상 변경 내역입니다.

```diff
diff --git a/Source/Valorant/AbilitySystem/Abilities/KAYO/KAYO_Q_FLASHDRIVE.cpp b/Source/Valorant/AbilitySystem/Abilities/KAYO/KAYO_Q_FLASHDRIVE.cpp
--- a/Source/Valorant/AbilitySystem/Abilities/KAYO/KAYO_Q_FLASHDRIVE.cpp
+++ b/Source/Valorant/AbilitySystem/Abilities/KAYO/KAYO_Q_FLASHDRIVE.cpp
@@
 #include "KAYO_Q_FLASHDRIVE.h"
+#include "AbilitySystemBlueprintLibrary.h" // (+) GameplayCue 전송을 위해 추가
@@
 bool UKAYO_Q_FLASHDRIVE::ThrowFlashbang(bool bAltFire)
 {
   // ... 투사체 스폰 위치 계산 ...
   if (Flashbang)
   {
-    // (기존) 이펙트/사운드를 직접 멀티캐스트로 재생
-    PlayCommonEffects(ProjectileLaunchEffect, ProjectileLaunchSound, SpawnLocation);
-    return true;
+    // (변경) GameplayCue로 FX/SFX 트리거를 위임
+    FGameplayCueParameters CueParams;
+    CueParams.Location = SpawnLocation;
+    UAbilitySystemBlueprintLibrary::SendGameplayCue(
+      GetAvatarActorFromActorInfo(),
+      FGameplayTag::RequestGameplayTag(TEXT("Cue.Ability.KAYO.Flash.Execute")),
+      CueParams);
+
+    return true;
   }
   // ...
 }
```

## 4. GameplayCue 통합 체크리스트

- [ ] **태그 정의**: `Cue.Ability.<Agent>.<Ability>.<Phase>` 형식의 `GameplayTag`를 `DefaultGameplayTags.ini`에 추가합니다.
- [ ] **호출부 수정**: 기존 `Multicast RPC` 또는 `PlayCommonEffects` 호출부를 `UAbilitySystemBlueprintLibrary::SendGameplayCue`로 대체합니다.
- [ ] **Cue Notify 생성**: 태그에 해당하는 `GameplayCue Notify` 블루프린트 에셋을 생성하고, `OnExecute` 이벤트에서 파티클, 사운드, 카메라 쉐이크 등을 재생하도록 구성합니다.
- [ ] **전파 범위 설정**: Cue Notify의 프로퍼티에서 이 Cue가 서버에서만 실행될지, 모든 클라이언트에게 복제될지, 소유한 클라이언트에게만 보일지 등을 설정합니다.

## 5. 장점 요약

*   **네트워크 최적화**: `GameplayCue` 시스템이 내부적으로 복제 및 최적화를 관리해주므로, 개발자가 수동으로 `Multicast RPC`를 호출하는 것보다 안정적이고 효율적입니다.
*   **유지보수성 향상**: 이펙트/사운드 로직이 어빌리티 C++ 코드에서 분리되므로, 코드의 가독성이 높아지고 유지보수가 용이해집니다.
*   **디자이너와의 협업**: 아티스트나 디자이너가 C++ 코드를 건드리지 않고 `GameplayCue Notify` 블루프린트 에셋을 직접 수정하여 시각/청각 효과를 자유롭게 변경하고 테스트할 수 있습니다.

## 6. 관련 문서

*   **[프로젝트 회고](./3_1_Project_Retrospective.md)**: 이 리팩토링의 배경과 필요성에 대해 설명합니다.
